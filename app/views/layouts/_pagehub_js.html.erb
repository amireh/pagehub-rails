<script>
  try       { if (pagehub_hooks); }
  catch(e)  { pagehub_hooks = []; }

  pagehub_hooks.push(function(application) {
    <% if Rails.env.development? %>
      app = application;
    <% end %>

    <% # TODO %>
    <% if false %>
      application.set('preferences', <%= p('app', DefaultPreferences).to_json %>);
    <% end %>

    application.set('preferences', {
      "user": {
        "skin": "light",

        "editing": {
          "font_face":      "Monospace",
          "font_size":      13,
          "line_height":    16,
          "letter_spacing": 0,
          "autosave":       true
        },

        "workspace": {
          "fluid": false,
          "scrolling": true,
          "animable": true,
          "browser": {
            "type": "finder"
          }
        },

        "runtime": {
          "spaces": {
          }
        }
      },

      "spaces": {
        "publishing": {
          "scheme": "Clean",
          "width": "960",
          "justified": false,
          "theme": {
            "name": "Clean"
          },

          "layout": {
            "name": "fluid",
            "show_homepages_in_sidebar": null,
            "show_breadcrumbs": null
          }
        }
      },

      "app": {
        "animes": {
          "toggling_duration": 250
        },

        "pulses": {
          "runtime_preferences": 1000,
          "page_content": 30000,
          "flash": {
            "error": 10000,
            "notice": 2500
          }
        },
        "lookup_pulse": 250
      }
    });

    require([ 'pagehub' ], function(UI) {
      require([ 'views/flash', 'models/user', 'models/space' ], function(Flash, User, Space) {
        application.on('bootstrapped', function() { application._bootstrapped = true; });
        application.Flash = new Flash(application);
        application.UI = UI;
        application.UI.initialize(application);

        <% if current_user %>
          try {
            application.current_user =
              new User(JSON.parse(_.unescape(<%= h(rabl :"/users/show", locals: { user: current_user }).to_json %>)).user);
          } catch(e) {
            console.log(e)
            // TODO: abort with an error
          }
        <% end %>

        <% if @user %>
          <% if current_user == @user %>
            application.user = application.current_user;
          <% else %>
            try {
              application.user =
                new User(JSON.parse(_.unescape(<%= h(rabl :"/users/public_show",  object: @user).to_json %>)).user);
            } catch(e) {
              console.log(e)
            }
          <% end %>
        <% end %>

        <% if @space %>
          application.space =
            new Space(JSON.parse(_.unescape(<%= h(rabl :"/spaces/show", object: @space).to_json %>)).space);
          <% if @space.creator == @user %>
            application.space.creator = application.user;
          <% elsif @space.creator == current_user %>
            application.space.creator = application.current_user;
          <% else %>
            try {
              application.space.creator =
                new User(JSON.parse(_.unescape(<%= h(rabl :"/users/public_show", locals: { user: @space.creator }).to_json %>)).user);
            } catch(e) {
              console.log(e)
            }
          <% end %>
        <% end %>

        <%= (yield :deferred_js).gsub(/\<\/?script\>/, '').strip.html_safe %>
      });
    });
  });
</script>